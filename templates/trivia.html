{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Prize Money Display -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Prize Money: ${{ question.prize_money|format_number }}</h3>
                </div>
            </div>

            <!-- Question Card -->
            <div class="card">
                <div class="card-header">
                    <h3>Level {{ question.level }}</h3>
                </div>
                <div class="card-body">
                    <h4 class="card-title">{{ question.question_text }}</h4>
                    
                    <!-- Lifelines -->
                    <div class="lifelines mb-4">
                        <button class="btn btn-outline-primary" id="fiftyFifty" {% if 'fifty_fifty' in used_lifelines %}disabled{% endif %}>
                            50:50
                        </button>
                        <button class="btn btn-outline-primary" id="phoneFriend" {% if 'phone_friend' in used_lifelines %}disabled{% endif %}>
                            Phone a Friend
                        </button>
                        <button class="btn btn-outline-primary" id="askAudience" {% if 'ask_audience' in used_lifelines %}disabled{% endif %}>
                            Ask the Audience
                        </button>
                    </div>

                    <form id="triviaForm" class="mt-4">
                        <input type="hidden" name="question_id" value="{{ question.id }}">
                        {% for option in question.options %}
                        <div class="form-check mb-3 option-container">
                            <input class="form-check-input" type="radio" name="answer" id="option{{ loop.index }}" value="{{ option }}">
                            <label class="form-check-label" for="option{{ loop.index }}">
                                {{ option }}
                            </label>
                        </div>
                        {% endfor %}
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-secondary" id="walkAway">Walk Away</button>
                            <button type="submit" class="btn btn-primary">Lock In Answer</button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Result Display -->
            <div id="result" class="mt-4" style="display: none;">
                <div class="alert" role="alert">
                    <h4 class="alert-heading"></h4>
                    <p class="result-text"></p>
                    <hr>
                    <p class="mb-0">Current Prize Money: $<span id="currentPrize">{{ current_prize|format_number }}</span></p>
                </div>
                <button class="btn btn-primary" onclick="location.reload()">Next Question</button>
            </div>

            <!-- Lifeline Results -->
            <div id="lifelineResult" class="modal fade" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Lifeline Result</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p id="lifelineText"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// Format number with commas
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Handle 50:50 lifeline
document.getElementById('fiftyFifty').addEventListener('click', function() {
    fetch('/trivia/fifty-fifty', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: document.querySelector('input[name="question_id"]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        const options = document.querySelectorAll('.option-container');
        options.forEach(option => {
            if (data.eliminated_options.includes(option.querySelector('input').value)) {
                option.style.display = 'none';
            }
        });
        this.disabled = true;
        showLifelineResult('50:50 used! Two incorrect options have been eliminated.');
    });
});

// Handle Phone a Friend lifeline
document.getElementById('phoneFriend').addEventListener('click', function() {
    fetch('/trivia/phone-friend', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: document.querySelector('input[name="question_id"]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        this.disabled = true;
        showLifelineResult(`Your friend says: "${data.advice}"`);
    });
});

// Handle Ask the Audience lifeline
document.getElementById('askAudience').addEventListener('click', function() {
    fetch('/trivia/ask-audience', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            question_id: document.querySelector('input[name="question_id"]').value
        })
    })
    .then(response => response.json())
    .then(data => {
        this.disabled = true;
        showLifelineResult(`Audience results: ${data.results}`);
    });
});

// Handle Walk Away
document.getElementById('walkAway').addEventListener('click', function() {
    if (confirm('Are you sure you want to walk away with your current prize money?')) {
        fetch('/trivia/walk-away', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                question_id: document.querySelector('input[name="question_id"]').value
            })
        })
        .then(response => response.json())
        .then(data => {
            showResult(true, data.prize_money);
        });
    }
});

// Handle form submission
document.getElementById('triviaForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/trivia/answer', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        showResult(data.correct, data.prize_money);
    });
});

function showResult(correct, prizeMoney) {
    const resultDiv = document.getElementById('result');
    const alertDiv = resultDiv.querySelector('.alert');
    const heading = resultDiv.querySelector('.alert-heading');
    const resultText = resultDiv.querySelector('.result-text');
    const currentPrize = document.getElementById('currentPrize');
    
    if (correct) {
        alertDiv.className = 'alert alert-success';
        heading.textContent = 'Correct!';
        resultText.textContent = `You've won $${formatNumber(prizeMoney)}!`;
    } else {
        alertDiv.className = 'alert alert-danger';
        heading.textContent = 'Incorrect!';
        resultText.textContent = `Game Over! You walk away with $${formatNumber(prizeMoney)}`;
    }
    
    currentPrize.textContent = formatNumber(prizeMoney);
    resultDiv.style.display = 'block';
    document.getElementById('triviaForm').style.display = 'none';
}

function showLifelineResult(text) {
    const modal = new bootstrap.Modal(document.getElementById('lifelineResult'));
    document.getElementById('lifelineText').textContent = text;
    modal.show();
}
</script>
{% endblock %}
{% endblock %} 